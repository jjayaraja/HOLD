/**
 * fileUploadPatch.js
 * 
 * This file adds file upload functionality to your existing Copilot Studio webclient
 * WITHOUT breaking your current working code.
 * 
 * INSTALLATION:
 * 1. Save this file as "fileUploadPatch.js" in your /web folder
 * 2. Add this line to your index.html AFTER the existing index.js import:
 *    <script type="module" src="./fileUploadPatch.js"></script>
 * 3. Add a file upload button to your HTML (see instructions below)
 */

console.log('File Upload Patch loaded');

// Wait for the page to load and existing code to initialize
window.addEventListener('load', () => {
    console.log('Initializing file upload patch...');
    
    // Wait a bit for your existing code to set up the client
    setTimeout(() => {
        initFileUploadSupport();
    }, 2000);
});

function initFileUploadSupport() {
    console.log('Setting up file upload support...');
    
    // Try to find the existing copilot client from window/global scope
    // Adjust these property names based on how your index.js exposes the client
    const client = window.copilotClient || window.client || findCopilotClient();
    
    if (!client) {
        console.warn('Copilot client not found. Make sure your existing code has initialized.');
        console.warn('You may need to expose the client: window.copilotClient = copilotClient;');
        return;
    }
    
    console.log('Found copilot client:', client);
    
    // Create file input if it doesn't exist
    createFileUploadUI();
    
    // Set up file upload handler
    setupFileUploadHandler(client);
}

// Find the copilot client from the global scope
function findCopilotClient() {
    // Check various possible locations
    const possibleLocations = [
        'copilotClient',
        'client', 
        'copilotStudioClient',
        'botClient'
    ];
    
    for (const location of possibleLocations) {
        if (window[location]) {
            console.log(`Found client at window.${location}`);
            return window[location];
        }
    }
    
    // Check if it's in a module scope (less likely but possible)
    return null;
}

// Create file upload UI elements
function createFileUploadUI() {
    // Check if file input already exists
    let fileInput = document.getElementById('file-input');
    let fileButton = document.getElementById('file-button');
    
    if (!fileInput) {
        console.log('Creating file input element...');
        fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.id = 'file-input';
        fileInput.style.display = 'none';
        document.body.appendChild(fileInput);
    }
    
    if (!fileButton) {
        console.log('Creating file upload button...');
        fileButton = document.createElement('button');
        fileButton.id = 'file-button';
        fileButton.textContent = 'ðŸ“Ž Upload File';
        fileButton.style.cssText = `
            padding: 10px 20px;
            background: #0078d4;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 10px;
        `;
        
        // Try to find the input area and add the button
        const inputArea = document.querySelector('.input-area') || 
                         document.querySelector('#input-area') ||
                         document.querySelector('[class*="input"]');
        
        if (inputArea) {
            inputArea.appendChild(fileButton);
        } else {
            // Fallback: add to body
            document.body.appendChild(fileButton);
        }
        
        // Connect button to file input
        fileButton.addEventListener('click', () => {
            fileInput.click();
        });
    }
}

// Set up the file upload handler
function setupFileUploadHandler(client) {
    const fileInput = document.getElementById('file-input');
    
    if (!fileInput) {
        console.error('File input not found');
        return;
    }
    
    console.log('Setting up file upload handler...');
    
    fileInput.addEventListener('change', async (event) => {
        const file = event.target.files[0];
        
        if (!file) {
            console.log('No file selected');
            return;
        }
        
        console.log('File selected:', {
            name: file.name,
            type: file.type,
            size: file.size
        });
        
        await handleFileUpload(file, client);
        
        // Reset input
        fileInput.value = '';
    });
}

// Handle the actual file upload
async function handleFileUpload(file, client) {
    try {
        // Show upload message
        addMessageToChat(`ðŸ“Ž Uploading: ${file.name} (${formatFileSize(file.size)})`, 'user');
        
        console.log('Starting file upload process...');
        
        // Step 1: Convert file to base64 data URL
        console.log('Converting file to base64...');
        const dataUrl = await readFileAsDataUrl(file);
        console.log('File converted, data URL length:', dataUrl.length);
        
        // Step 2: Create activity with attachment
        const activity = {
            type: 'message',
            from: { id: 'user' },
            attachments: [{
                contentType: file.type || 'application/octet-stream',
                contentUrl: dataUrl,
                name: file.name
            }]
        };
        
        console.log('Created activity:', {
            type: activity.type,
            attachmentCount: activity.attachments.length,
            fileName: activity.attachments[0].name,
            fileType: activity.attachments[0].contentType
        });
        
        // Step 3: Get conversation ID
        const conversationId = client.conversationId || 
                              window.conversationId || 
                              getConversationId();
        
        if (!conversationId) {
            throw new Error('Conversation ID not found');
        }
        
        console.log('Using conversation ID:', conversationId);
        
        // Step 4: Send activity
        console.log('Sending file activity...');
        
        // Try different possible method names
        let replies;
        if (typeof client.sendActivityAsync === 'function') {
            replies = await client.sendActivityAsync(activity, conversationId);
        } else if (typeof client.postActivity === 'function') {
            replies = await client.postActivity(activity);
        } else if (typeof client.sendActivity === 'function') {
            replies = await client.sendActivity(activity, conversationId);
        } else {
            throw new Error('No suitable send method found on client');
        }
        
        console.log('File sent successfully! Replies:', replies);
        
        // Display bot responses
        if (Array.isArray(replies)) {
            replies.forEach(reply => {
                if (reply && reply.text) {
                    addMessageToChat(reply.text, 'bot');
                }
            });
        }
        
        addMessageToChat(`âœ“ File uploaded: ${file.name}`, 'system');
        
    } catch (error) {
        console.error('File upload error:', error);
        console.error('Error stack:', error.stack);
        addMessageToChat(`âœ— Upload failed: ${error.message}`, 'error');
    }
}

// Convert file to base64 data URL
function readFileAsDataUrl(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        
        reader.onload = function(event) {
            resolve(event.target.result);
        };
        
        reader.onerror = function(error) {
            reject(new Error('Failed to read file: ' + error));
        };
        
        reader.readAsDataURL(file);
    });
}

// Get conversation ID from various possible locations
function getConversationId() {
    return window.conversationId || 
           document.getElementById('conversationId')?.value ||
           localStorage.getItem('conversationId');
}

// Add message to chat UI
function addMessageToChat(text, type) {
    // Try to find the chat container
    const chatContainer = document.getElementById('chat-container') ||
                         document.querySelector('.chat-container') ||
                         document.querySelector('[class*="chat"]') ||
                         document.querySelector('[id*="chat"]');
    
    if (!chatContainer) {
        console.log('Message:', text);
        return;
    }
    
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${type}-message`;
    messageDiv.textContent = text;
    
    // Add some basic styling if no class exists
    if (!document.querySelector(`.${type}-message`)) {
        messageDiv.style.cssText = `
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            ${type === 'user' ? 'background: #0078d4; color: white; text-align: right;' : ''}
            ${type === 'bot' ? 'background: #f3f2f1; color: black;' : ''}
            ${type === 'error' ? 'background: #fde7e9; color: #c50f1f;' : ''}
            ${type === 'system' ? 'background: #d4edda; color: #155724;' : ''}
        `;
    }
    
    chatContainer.appendChild(messageDiv);
    chatContainer.scrollTop = chatContainer.scrollHeight;
}

// Format file size for display
function formatFileSize(bytes) {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
    return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
}

console.log('File Upload Patch ready');

// Export for debugging
window.fileUploadPatch = {
    handleFileUpload,
    readFileAsDataUrl,
    addMessageToChat
};
