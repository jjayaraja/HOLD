// index.js - UPDATED for File Upload Support
// This file shows the CRITICAL CHANGES needed to make file uploads work

import { CopilotStudioClient } from '@microsoft/agents-copilotstudio-client/dist/src/browser.mjs';
import { loadCopilotStudioConnectionSettingsFromEnv } from './settings.js';
import { acquireToken } from './acquireToken.js';

let copilotClient = null;
let conversationId = null;

// Initialize the Copilot Studio client
async function initialize() {
    try {
        console.log('Loading settings...');
        const settings = loadCopilotStudioConnectionSettingsFromEnv();
        
        console.log('Acquiring token...');
        const token = await acquireToken(settings);
        
        console.log('Creating Copilot Studio client...');
        copilotClient = new CopilotStudioClient(settings, token);
        
        console.log('Starting conversation...');
        const replies = await copilotClient.startConversationAsync(true);
        conversationId = copilotClient.conversationId;
        
        console.log('Conversation started:', conversationId);
        
        // Display initial messages
        replies.forEach(r => {
            if (r.text) {
                displayMessage(r.text, 'bot');
            }
        });
        
        // Enable UI controls
        enableControls();
        
    } catch (error) {
        console.error('Initialization error:', error);
        displayError('Failed to connect: ' + error.message);
    }
}

// Send text message
async function sendMessage(text) {
    if (!copilotClient || !text.trim()) return;
    
    displayMessage(text, 'user');
    
    try {
        const replies = await copilotClient.askQuestionAsync(text, conversationId);
        
        replies.forEach(r => {
            if (r.text) {
                displayMessage(r.text, 'bot');
            }
        });
    } catch (error) {
        console.error('Error sending message:', error);
        displayError('Error: ' + error.message);
    }
}

// **CRITICAL FIX: Handle file upload**
// This is the key change needed for file uploads to work
async function handleFileUpload(file) {
    if (!copilotClient || !file) {
        console.error('Client not initialized or no file provided');
        return;
    }
    
    console.log('Processing file upload:', {
        name: file.name,
        type: file.type,
        size: file.size
    });
    
    displayMessage(`ðŸ“Ž Uploading: ${file.name}`, 'user');
    
    try {
        // Step 1: Convert file to base64 data URL
        console.log('Converting file to base64...');
        const dataUrl = await readFileAsDataUrl(file);
        
        // Step 2: Create the activity with attachment
        // IMPORTANT: This is the EXACT format Copilot Studio expects
        const activity = {
            type: 'message',
            from: { 
                id: 'user' 
            },
            // DO NOT include 'text' field when sending file-only uploads
            attachments: [{
                contentType: file.type || 'application/octet-stream',
                contentUrl: dataUrl,  // MUST be a data URL (data:mime/type;base64,...)
                name: file.name
            }]
        };
        
        console.log('Sending file activity with attachment:', {
            fileName: file.name,
            fileType: file.type,
            dataUrlLength: dataUrl.length,
            activityType: activity.type
        });
        
        // Step 3: Use sendActivityAsync (NOT askQuestionAsync) for file uploads
        // This is CRITICAL - askQuestionAsync won't work for attachments
        const replies = await copilotClient.sendActivityAsync(activity, conversationId);
        
        console.log('File upload successful, received replies:', replies.length);
        
        // Display bot responses
        replies.forEach(r => {
            if (r.text) {
                displayMessage(r.text, 'bot');
            }
        });
        
    } catch (error) {
        console.error('File upload error:', error);
        console.error('Error stack:', error.stack);
        displayError(`Upload failed: ${error.message}`);
    }
}

// Convert File to base64 Data URL
function readFileAsDataUrl(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        
        reader.onload = function(event) {
            // Result is in format: data:application/pdf;base64,JVBERi0x...
            const dataUrl = event.target.result;
            console.log('File converted to data URL:', {
                length: dataUrl.length,
                prefix: dataUrl.substring(0, 50) + '...'
            });
            resolve(dataUrl);
        };
        
        reader.onerror = function(error) {
            console.error('FileReader error:', error);
            reject(new Error('Failed to read file: ' + error.message));
        };
        
        // Read as data URL (base64)
        reader.readAsDataURL(file);
    });
}

// UI Helper Functions
function displayMessage(text, sender) {
    const chatContainer = document.getElementById('chat-container');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${sender}-message`;
    messageDiv.textContent = text;
    chatContainer.appendChild(messageDiv);
    chatContainer.scrollTop = chatContainer.scrollHeight;
}

function displayError(message) {
    displayMessage(message, 'error');
}

function enableControls() {
    document.getElementById('message-input').disabled = false;
    document.getElementById('send-button').disabled = false;
    document.getElementById('file-button').disabled = false;
}

// Event Listeners Setup
function setupEventListeners() {
    const messageInput = document.getElementById('message-input');
    const sendButton = document.getElementById('send-button');
    const fileButton = document.getElementById('file-button');
    const fileInput = document.getElementById('file-input');
    
    sendButton.addEventListener('click', () => {
        const text = messageInput.value;
        if (text.trim()) {
            sendMessage(text);
            messageInput.value = '';
        }
    });
    
    messageInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            const text = messageInput.value;
            if (text.trim()) {
                sendMessage(text);
                messageInput.value = '';
            }
        }
    });
    
    fileButton.addEventListener('click', () => {
        fileInput.click();
    });
    
    // CRITICAL: File input change handler
    fileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            console.log('File selected:', file.name);
            handleFileUpload(file);
            // Reset so same file can be uploaded again
            fileInput.value = '';
        }
    });
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', () => {
    console.log('Page loaded, setting up...');
    setupEventListeners();
    initialize();
});

// Export for use in other modules if needed
export { initialize, sendMessage, handleFileUpload };





















<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Copilot Studio Web Client</title>
    <link rel="stylesheet" href="index.css">
</head>
<body>
    <div class="container">
        <h1>Copilot Studio Agent</h1>
        
        <div id="status" class="status">Connecting...</div>
        
        <div id="chat-container" class="chat-container"></div>
        
        <div class="input-area">
            <input 
                type="text" 
                id="message-input" 
                placeholder="Type your message..." 
                disabled
            />
            <button id="send-button" disabled>Send</button>
            <button id="file-button" disabled>ðŸ“Ž Upload</button>
            
            <!-- Hidden file input -->
            <input 
                type="file" 
                id="file-input" 
                style="display: none;"
                accept="*/*"
            />
        </div>
    </div>

    <!-- 
        IMPORTANT: Use type="module" to support ES6 imports 
        Make sure the path matches your actual file location
    -->
    <script type="module">
        import { CopilotStudioClient } from './agents-copilotstudio-client/dist/src/browser.mjs';
        
        // Import settings - adjust path if your settings.js is different
        // If you're using settings.TEMPLATE.js, rename it to settings.js first
        
        // For this example, we'll define settings inline
        // In production, import from your settings.js file
        const settings = {
            environmentId: 'YOUR_ENVIRONMENT_ID',
            schemaName: 'YOUR_SCHEMA_NAME', 
            tenantId: 'YOUR_TENANT_ID'
        };
        
        let copilotClient = null;
        let conversationId = null;
        
        // Get DOM elements
        const chatContainer = document.getElementById('chat-container');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const fileButton = document.getElementById('file-button');
        const fileInput = document.getElementById('file-input');
        const statusDiv = document.getElementById('status');
        
        // Initialize client
        async function initialize() {
            try {
                statusDiv.textContent = 'Getting authentication...';
                
                // Get token - you need to implement this based on your auth setup
                // Import from acquireToken.js or implement inline
                const token = await getAuthToken();
                
                statusDiv.textContent = 'Connecting to agent...';
                
                copilotClient = new CopilotStudioClient(settings, token);
                
                const replies = await copilotClient.startConversationAsync(true);
                conversationId = copilotClient.conversationId;
                
                console.log('Connected! Conversation ID:', conversationId);
                statusDiv.textContent = 'Connected âœ“';
                
                // Enable controls
                messageInput.disabled = false;
                sendButton.disabled = false;
                fileButton.disabled = false;
                
                // Display initial messages
                replies.forEach(r => {
                    if (r.text) addMessage(r.text, 'bot');
                });
                
            } catch (error) {
                console.error('Init error:', error);
                statusDiv.textContent = 'Connection failed: ' + error.message;
                statusDiv.style.color = 'red';
            }
        }
        
        // Send text message
        async function sendMessage() {
            const text = messageInput.value.trim();
            if (!text || !copilotClient) return;
            
            addMessage(text, 'user');
            messageInput.value = '';
            
            try {
                const replies = await copilotClient.askQuestionAsync(text, conversationId);
                replies.forEach(r => {
                    if (r.text) addMessage(r.text, 'bot');
                });
            } catch (error) {
                console.error('Send error:', error);
                addMessage('Error: ' + error.message, 'error');
            }
        }
        
        // **THIS IS THE CRITICAL FIX FOR FILE UPLOADS**
        async function uploadFile(file) {
            if (!file || !copilotClient) return;
            
            addMessage(`ðŸ“Ž ${file.name} (${formatSize(file.size)})`, 'user');
            
            try {
                console.log('Converting file to base64...');
                const dataUrl = await readFileAsDataUrl(file);
                
                // CRITICAL: This is the exact format needed
                const activity = {
                    type: 'message',
                    from: { id: 'user' },
                    attachments: [{
                        contentType: file.type || 'application/octet-stream',
                        contentUrl: dataUrl,  // MUST be data URL
                        name: file.name
                    }]
                };
                
                console.log('Sending file activity:', {
                    name: file.name,
                    type: file.type,
                    size: file.size
                });
                
                // CRITICAL: Use sendActivityAsync, NOT askQuestionAsync
                const replies = await copilotClient.sendActivityAsync(activity, conversationId);
                
                console.log('File sent! Replies:', replies.length);
                
                replies.forEach(r => {
                    if (r.text) addMessage(r.text, 'bot');
                });
                
            } catch (error) {
                console.error('Upload error:', error);
                addMessage('Upload failed: ' + error.message, 'error');
            }
        }
        
        // Convert file to data URL
        function readFileAsDataUrl(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = (e) => reject(e);
                reader.readAsDataURL(file);
            });
        }
        
        // Helper: Add message to chat
        function addMessage(text, type) {
            const div = document.createElement('div');
            div.className = `message ${type}`;
            div.textContent = text;
            chatContainer.appendChild(div);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
        
        // Helper: Format file size
        function formatSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }
        
        // Get auth token - REPLACE THIS with your actual auth implementation
        async function getAuthToken() {
            // Option 1: If you have acquireToken.js, import and use it
            // import { acquireToken } from './acquireToken.js';
            // return await acquireToken(settings);
            
            // Option 2: Get from your backend
            // const response = await fetch('/api/token');
            // return (await response.json()).token;
            
            // Option 3: Use MSAL (if configured)
            // return await msalInstance.acquireTokenSilent(...);
            
            // For testing, you can temporarily hardcode (NOT for production!)
            throw new Error('Please implement getAuthToken() with your authentication method');
        }
        
        // Event listeners
        sendButton.onclick = sendMessage;
        messageInput.onkeypress = (e) => {
            if (e.key === 'Enter') sendMessage();
        };
        fileButton.onclick = () => fileInput.click();
        fileInput.onchange = (e) => {
            const file = e.target.files[0];
            if (file) {
                uploadFile(file);
                fileInput.value = ''; // Reset
            }
        };
        
        // Start
        initialize();
    </script>
</body>
</html>

