# Building a simple web app for a Copilot Studio agent using the Microsoft 365 Agent SDK

This guide shows how to wrap an existing Copilot Studio agent in a lightweight web application that authenticates users with Microsoft Entra (Azure AD) and chats with the agent through the Microsoft 365 Agent SDK.

## Architecture overview
- **Front end**: Single-page app that uses `@azure/msal-browser` for Microsoft sign-in and the Microsoft 365 Agent SDK for chat.
- **Backend (optional)**: Only needed to proxy file uploads or hide secrets (e.g., a Power Platform connection string for auxiliary APIs). Otherwise the SDK can be used directly from the browser.
- **Identity**: Users sign in with Microsoft accounts; the SDK exchanges the MSAL token to authorize access to the agent.

## Prerequisites
- A published Copilot Studio agent with Microsoft authentication enabled.
- An Entra app registration configured as a Single Page Application with redirect URIs for your web host (e.g., `https://localhost:3000` during development).
- The agent ID (from Copilot Studio) and tenant ID.
- Node.js 18+.

## Project setup
1. Initialize a new project:
   ```bash
   npm init -y
   npm install @azure/msal-browser @microsoft/agents-js
   npm install --save-dev vite
   ```
2. Add a `.env` file (or similar) with values from your Entra app and Copilot Studio agent:
   ```env
   VITE_AZURE_AD_CLIENT_ID=<web-app-client-id>
   VITE_AZURE_AD_TENANT_ID=<tenant-id>
   VITE_AGENT_ID=<copilot-studio-agent-id>
   VITE_API_SCOPE=https://api.powerva.microsoft.com/.default
   ```

## Minimal front-end entry point (e.g., `src/main.ts`)
```ts
import { PublicClientApplication, InteractionRequiredAuthError } from "@azure/msal-browser";
import { AgentClient } from "@microsoft/agents-js";

const msal = new PublicClientApplication({
  auth: {
    clientId: import.meta.env.VITE_AZURE_AD_CLIENT_ID,
    authority: `https://login.microsoftonline.com/${import.meta.env.VITE_AZURE_AD_TENANT_ID}`
  },
  cache: { cacheLocation: "localStorage" }
});

async function getToken() {
  try {
    const result = await msal.acquireTokenSilent({ scopes: [import.meta.env.VITE_API_SCOPE] });
    return result.accessToken;
  } catch (err) {
    if (err instanceof InteractionRequiredAuthError) {
      const result = await msal.loginPopup({ scopes: [import.meta.env.VITE_API_SCOPE] });
      return result.accessToken;
    }
    throw err;
  }
}

async function createAgentClient() {
  const accessToken = await getToken();
  return new AgentClient({
    auth: () => accessToken,
    agentId: import.meta.env.VITE_AGENT_ID,
    tenantId: import.meta.env.VITE_AZURE_AD_TENANT_ID
  });
}

async function sendMessage(text: string) {
  const client = await createAgentClient();
  const chat = await client.createConversation();
  const response = await chat.sendMessage({ text });

  // Stream tokens as they arrive
  response.on("message", (chunk) => {
    console.log(chunk.text);
  });
}

sendMessage("Hello from the web app!");
```

### Handling file uploads
If your agent expects file uploads, use an `<input type="file">` element, then pass a `File` object to the SDK:
```ts
const fileInput = document.querySelector("input[type=file]") as HTMLInputElement;
fileInput.addEventListener("change", async () => {
  if (!fileInput.files?.length) return;
  const client = await createAgentClient();
  const chat = await client.createConversation();
  await chat.sendMessage({ text: "Analyze this file", attachments: [fileInput.files[0]] });
});
```

### Calling downstream Power Platform APIs
If you need to use a Power Platform connection string from the web app:
1. Expose a small backend that protects the connection string and exchanges the MSAL token for your API (using the On-Behalf-Of flow).
2. Call that backend from the front end after the user signs in. Do **not** ship the connection string to the browser.

## Local development
Add a simple Vite script to `package.json`:
```json
{
  "scripts": {
    "dev": "vite",
    "build": "vite build",
    "preview": "vite preview"
  }
}
```
Then run `npm run dev` and browse to the local URL. Because only Microsoft login is enabled, MSAL will prompt users to sign in with their Microsoft accounts before the SDK can talk to the agent.

## Deployment tips
- Register production redirect URIs in the Entra app before going live.
- Consider enabling Conditional Access and verifying that your app only requests the minimal scope (`https://api.powerva.microsoft.com/.default`).
- If hosting behind a custom domain, configure CORS on any backend proxy you expose for file uploads or Power Platform calls.
```
