
import { acquireToken } from './acquireToken.js';
import { settings } from './settings.js';

(async function initWebChat() {
  if (document.readyState === 'loading') {
    await new Promise(resolve => document.addEventListener('DOMContentLoaded', resolve));
  }

  const webchatDiv = document.getElementById('webchat');
  if (!webchatDiv) {
    throw new Error('Element with id "webchat" not found');
  }

  const token = await acquireToken(settings);
  const client = new CopilotStudioClient(settings, token);
  const directLine = CopilotStudioWebChat.createConnection(client, { showTyping: true });

  // Guarantee a minimal text value before Copilot Studio validates activities.
  const originalPostActivity = directLine.postActivity.bind(directLine);
  directLine.postActivity = activity => {
    if (!activity.text || !activity.text.trim()) {
      activity.text = ' ';
    }
    return originalPostActivity(activity);
  };

  // Ensure all activities have minimal text only when missing.
  const store = window.WebChat.createStore({}, () => next => action => {
    if (action.type === 'DIRECT_LINE/POST_ACTIVITY') {
      const activity = action.payload.activity;
      if (!activity.text) {
        activity.text = ' '; // satisfies Copilot Studio validation
      }

      if (activity.attachments?.length) {
        activity.attachments = activity.attachments.map(attachment => {
          // Preserve non-file attachments untouched.
          const blob = attachment?.blob;
          if (!blob || !(blob instanceof Blob)) {
            return attachment;
          }

          // Convert Blob to base64 inline content (preferred by Copilot Studio Question/File nodes).
          return {
            name: attachment.name,
            contentType: attachment.contentType || 'application/octet-stream',
            thumbnailUrl: attachment.thumbnailUrl,
            blob, // keep blob so attachmentMiddleware can read it
            content: attachment.content // keep existing content if provided
          };
        });
      }
    }

    return next(action);
  });

  // Attachment middleware converts only genuine Blob uploads to base64.
  const attachmentMiddleware = () => next => ({ activity, attachment }) => {
    const baseAttachment = next({ activity, attachment });
    const blob = attachment?.blob;

    if (!blob || !(blob instanceof Blob)) {
      return baseAttachment; // skip non-file payloads (prevents FileReader errors)
    }

    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => {
        const base64 = reader.result.split(',')[1];
        resolve({
          ...baseAttachment,
          name: attachment.name,
          contentType: attachment.contentType || 'application/octet-stream',
          content: base64
        });
      };
      reader.onerror = () => reject(reader.error);
      reader.readAsDataURL(blob);
    });
  };

  window.WebChat.renderWebChat(
    {
      directLine,
      store,
      attachmentMiddleware,
      styleOptions: { hideUploadButton: false, botAvatarInitials: 'CS', userAvatarInitials: 'You' }
    },
    webchatDiv
  );
})();
