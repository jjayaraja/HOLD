// Import the necessary functions from acquireToken.js
import { acquireToken } from './acquireToken.js';
import { settings } from './settings.js';

(async function() {
    // Wait for DOM to be fully loaded
    if (document.readyState === 'loading') {
        await new Promise(resolve => {
            document.addEventListener('DOMContentLoaded', resolve);
        });
    }
    
    try {
        console.log('Initializing Copilot Studio Web Client...');
        
        // Verify webchat container exists
        const webchatDiv = document.getElementById('webchat');
        if (!webchatDiv) {
            throw new Error('Element with id "webchat" not found in DOM');
        }
        console.log('Webchat container found');
        
        // Acquire the authentication token
        const token = await acquireToken(settings);
        console.log('Token acquired successfully');

        // Initialize the Copilot Studio client
        const client = new CopilotStudioClient(settings, token);
        console.log('CopilotStudio client initialized');

        // Create the WebChat connection
        const directLine = CopilotStudioWebChat.createConnection(client, {
            showTyping: true
        });
        console.log('DirectLine connection created');

        // Wrap the postActivity method to ensure all activities have required properties
        const originalPostActivity = directLine.postActivity.bind(directLine);
        directLine.postActivity = (activity) => {
            console.log('postActivity intercepted - original activity:', activity);
            
            // CopilotStudio SDK requires text property for ALL activities, even events
            // This is different from standard Bot Framework behavior
            if (!activity.text) {
                activity.text = ' '; // Add minimal text to satisfy SDK validation
                console.log('Added text property to activity');
            }
            
            console.log('Calling original postActivity with:', activity);
            return originalPostActivity(activity);
        };

        // Create a store with middleware to handle Question node file responses
        const store = window.WebChat.createStore({}, ({ dispatch }) => next => action => {
            if (action.type === 'DIRECT_LINE/POST_ACTIVITY') {
                const activity = action.payload.activity;
                
                console.log('Store middleware - Activity:', {
                    type: activity.type,
                    hasText: !!activity.text,
                    text: activity.text
                });
                
                // CRITICAL: CopilotStudio SDK requires text property for ALL activities
                // Add it immediately if missing, regardless of activity type
                if (!activity.text) {
                    activity.text = ' ';
                    console.log('Store middleware: Added text property to', activity.type, 'activity');
                }
                
                // Handle file uploads (user responding to Question node)
                if (activity.attachments && activity.attachments.length > 0) {
                    console.log(`User uploading ${activity.attachments.length} file(s) in response to bot question`);
                    
                    // Text already added at top of middleware
                    
                    // CRITICAL FIX: Copilot Studio needs inline content, not contentUrl
                    // Convert contentUrl attachments to inline content
                    activity.attachments = activity.attachments.map((attachment, idx) => {
                        console.log(`Attachment ${idx} (before):`, {
                            name: attachment.name,
                            contentType: attachment.contentType,
                            hasContentUrl: !!attachment.contentUrl,
                            hasContent: !!attachment.content,
                            size: attachment.contentUrl ? 'URL' : (attachment.content ? `${attachment.content.length} bytes` : 'unknown')
                        });
                        
                        // Ensure we're sending the right format
                        const processedAttachment = {
                            contentType: attachment.contentType || 'application/octet-stream',
                            name: attachment.name
                        };
                        
                        // Prefer inline content over contentUrl for Copilot Studio
                        if (attachment.content) {
                            processedAttachment.content = attachment.content;
                            console.log(`Attachment ${idx}: Using inline content (${attachment.content.length} bytes)`);
                        } else if (attachment.contentUrl) {
                            // Keep contentUrl as fallback
                            processedAttachment.contentUrl = attachment.contentUrl;
                            console.warn(`Attachment ${idx}: Only has contentUrl - may not work with Copilot Studio Question node`);
                        }
                        
                        if (attachment.thumbnailUrl) {
                            processedAttachment.thumbnailUrl = attachment.thumbnailUrl;
                        }
                        
                        return processedAttachment;
                    });
                    
                    console.log('File activity prepared for Question node response');
                }
                
                // Log all outgoing activities for debugging
                console.log('Outgoing activity:', {
                    type: activity.type,
                    text: activity.text,
                    hasAttachments: !!(activity.attachments && activity.attachments.length > 0),
                    attachmentCount: activity.attachments ? activity.attachments.length : 0
                });
            }
            
            return next(action);
        });

        // Configure attachment upload to send inline content instead of URLs
        // This is critical for Copilot Studio Question nodes with File entity
        const attachmentMiddleware = () => next => ({ activity, attachment }) => {
            const { name, blob, contentType, thumbnailBlob } = attachment;
            
            console.log('attachmentMiddleware processing:', { name, contentType, blobSize: blob?.size });
            
            // Convert blob to base64 for inline content
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = () => {
                    const base64Data = reader.result.split(',')[1]; // Remove data:*/*;base64, prefix
                    
                    console.log('File converted to base64:', {
                        name,
                        contentType,
                        base64Length: base64Data.length
                    });
                    
                    // Return attachment with inline content
                    resolve({
                        ...next({ activity, attachment }),
                        content: base64Data, // Inline base64 content
                        contentType: contentType,
                        name: name
                    });
                };
                
                reader.onerror = () => {
                    console.error('Failed to read file:', reader.error);
                    reject(reader.error);
                };
                
                reader.readAsDataURL(blob);
            });
        };

        // Render the WebChat component
        window.WebChat.renderWebChat(
            {
                directLine: directLine,
                store: store,
                attachmentMiddleware: attachmentMiddleware,
                styleOptions: {
                    botAvatarInitials: 'CS',
                    userAvatarInitials: 'You',
                    hideUploadButton: false
                },
                sendTypingIndicator: true,
                onError: (error) => {
                    console.error('WebChat error:', error);
                }
            },
            document.getElementById('webchat')
        );

        console.log('WebChat rendered successfully');
        console.log('Bot will ask for file upload when ready. Use the attachment button to respond.');

        // Don't manually subscribe to activity$ as it may cause issues
        // Let Web Chat handle everything automatically
        
        console.log('Web Chat initialized. Waiting for bot to start conversation...');

    } catch (error) {
        console.error('Error initializing Copilot Studio client:', error);
        
        const webchatDiv = document.getElementById('webchat');
        if (webchatDiv) {
            webchatDiv.innerHTML = `
                <div style="padding: 20px; color: #d32f2f; background-color: #ffebee; border-radius: 4px; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">
                    <h3 style="margin-top: 0;">‚ùå Failed to Initialize Chat</h3>
                    <p><strong>Error:</strong> ${error.message}</p>
                    
                    <h4>Common Issues:</h4>
                    <ul style="line-height: 1.6;">
                        <li><strong>settings.js:</strong> Verify all fields are configured correctly</li>
                        <li><strong>Authentication:</strong> Ensure Azure AD app has correct permissions</li>
                        <li><strong>Network:</strong> Check browser console (F12) for CORS or network errors</li>
                        <li><strong>Bot Status:</strong> Verify your Copilot Studio bot is published</li>
                    </ul>
                    
                    <p style="margin-top: 15px; padding: 10px; background: #fff3cd; border-left: 4px solid #ffc107; color: #856404;">
                        <strong>üí° Tip:</strong> Open browser DevTools (F12) ‚Üí Console tab for detailed error logs
                    </p>
                </div>
            `;
        }
    }
})();
